<!-- Main Application Container -->
<div class="bg-slate-900 text-white min-h-screen font-sans p-4 sm:p-6 lg:p-8">
  <div class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-cyan-400">Infection Cluster Detection</h1>
      <p class="text-slate-400 mt-2">Upload hospital data to identify and visualize infection clusters.</p>
    </header>

    <!-- File Upload Section -->
    <div class="bg-slate-800 p-6 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4 text-slate-200">1. Upload Data</h2>
      <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label for="transfers-file" class="block text-sm font-medium text-slate-400 mb-2">Transfers Data (.csv)</label>
            <input (change)="onFileSelect($event, 'transfers')" type="file" id="transfers-file" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700 cursor-pointer"/>
            <span class="text-xs text-slate-500 mt-1 block">{{ files().transfers?.name || 'No file selected.' }}</span>
          </div>
          <div class="flex-1">
            <label for="microbiology-file" class="block text-sm font-medium text-slate-400 mb-2">Microbiology Data (.csv)</label>
            <input (change)="onFileSelect($event, 'microbiology')" type="file" id="microbiology-file" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700 cursor-pointer"/>
             <span class="text-xs text-slate-500 mt-1 block">{{ files().microbiology?.name || 'No file selected.' }}</span>
          </div>
      </div>
      <div class="mt-6 text-right">
         <button (click)="handleUpload()" [disabled]="!files().transfers || !files().microbiology || isLoading()" class="bg-green-600 hover:bg-green-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
            {{ isLoading() ? 'Processing...' : 'Detect Clusters' }}
         </button>
      </div>
       <!-- Error Message -->
      @if (error()) {
        <div class="mt-4 bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded-lg" role="alert">
          <strong class="font-bold">Error:</strong>
          <span class="block sm:inline">{{ error() }}</span>
        </div>
      }
    </div>

    <!-- Main Content Area with Sidebar Layout -->
    @if (clusters().length > 0) {
      <div class="bg-slate-800 rounded-lg shadow-lg overflow-hidden">
        <h2 class="text-2xl font-semibold p-6 pb-4 text-slate-200">2. View Detected Clusters</h2>
        
        <!-- AIDEV-NOTE: Two-panel sidebar layout as specified in CLAUDE.md -->
        <div class="grid grid-cols-[350px_1fr] min-h-[600px]">
          <!-- Left Sidebar -->
          <div class="bg-slate-700 flex flex-col border-r border-slate-600">
            <!-- Sidebar Navigation -->
            <div class="flex border-b border-slate-600">
              <button (click)="setView('table')" [class.active]="currentView() === 'table'" class="flex-1 p-3 text-sm font-medium text-slate-300 hover:text-white border-b-2 border-transparent hover:border-cyan-400 transition-colors" [class]="currentView() === 'table' ? 'text-cyan-400 border-cyan-400' : ''">Table</button>
              <button (click)="setView('list')" [class.active]="currentView() === 'list'" class="flex-1 p-3 text-sm font-medium text-slate-300 hover:text-white border-b-2 border-transparent hover:border-cyan-400 transition-colors" [class]="currentView() === 'list' ? 'text-cyan-400 border-cyan-400' : ''">List</button>
            </div>

            <!-- Sidebar Content Area -->
            <div class="flex-1 overflow-y-auto p-4">
              <!-- Table View -->
              @if (currentView() === 'table') {
                <div id="table-view">
                  <div class="space-y-2">
                    @for(cluster of paginatedClusters(); track cluster.id) {
                      <div (click)="selectCluster(cluster)" 
                           [class.selected]="selectedCluster()?.id === cluster.id"
                           class="cluster-item bg-slate-800 hover:bg-slate-600 p-3 rounded cursor-pointer border border-transparent hover:border-cyan-400 transition-all">
                        <div class="flex justify-between items-start mb-2">
                          <h4 class="font-semibold text-cyan-300">{{ cluster.infection }}</h4>
                          <span class="text-xs bg-slate-600 px-2 py-1 rounded text-slate-300">{{ cluster.id }}</span>
                        </div>
                        <p class="text-sm text-slate-400 mb-1">{{ cluster.patientCount }} patients</p>
                        <div class="text-xs text-slate-500 line-clamp-2">
                          {{ cluster.patients.slice(0, 3).join(', ') }}
                          @if (cluster.patients.length > 3) { <span>...</span> }
                        </div>
                      </div>
                    }
                  </div>
                  <!-- Table Pagination -->
                  <div class="flex justify-between items-center mt-4 text-xs">
                    <span class="text-slate-400">{{ currentPage() }}/{{ totalPages() }}</span>
                    <div class="inline-flex">
                      <button (click)="prevPage()" [disabled]="currentPage() === 1" class="pagination-button-small rounded-l">‹</button>
                      <button (click)="nextPage()" [disabled]="currentPage() === totalPages()" class="pagination-button-small rounded-r">›</button>
                    </div>
                  </div>
                </div>
              }

              <!-- List View -->
              @if (currentView() === 'list') {
                <div id="list-view">
                  <div class="space-y-3">
                    @for(cluster of paginatedClusters(); track cluster.id) {
                      <div (click)="selectCluster(cluster)"
                           [class.selected]="selectedCluster()?.id === cluster.id"
                           class="cluster-item bg-slate-800 hover:bg-slate-600 p-4 rounded cursor-pointer border border-transparent hover:border-cyan-400 transition-all">
                        <div class="flex justify-between items-center mb-2">
                          <h3 class="font-bold text-lg text-cyan-400">{{ cluster.infection }}</h3>
                          <span class="text-xs bg-slate-600 px-2 py-1 rounded-full">{{ cluster.id }}</span>
                        </div>
                        <p class="text-sm text-slate-300 mb-3">{{ cluster.patientCount }} Patients</p>
                        <div class="text-xs text-slate-400 bg-slate-900 p-2 rounded max-h-20 overflow-y-auto">
                          {{ cluster.patients.join(', ') }}
                        </div>
                      </div>
                    }
                  </div>
                  <!-- List Pagination -->
                  <div class="flex justify-between items-center mt-4 text-xs">
                    <span class="text-slate-400">{{ currentPage() }}/{{ totalPages() }}</span>
                    <div class="inline-flex">
                      <button (click)="prevPage()" [disabled]="currentPage() === 1" class="pagination-button-small rounded-l">‹</button>
                      <button (click)="nextPage()" [disabled]="currentPage() === totalPages()" class="pagination-button-small rounded-r">›</button>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- LLM Analyzer at Bottom of Sidebar -->
            <div class="border-t border-slate-600 p-4 bg-slate-800">
              <h3 class="text-sm font-semibold text-slate-300 mb-2">LLM Analyzer</h3>
              <select (change)="onAnalyzerFilterChange($event)" 
                      [value]="selectedAnalysisType()"
                      class="w-full bg-slate-600 border border-slate-500 text-slate-200 text-xs p-2 rounded mb-2">
                <option value="">Select analysis type...</option>
                <option value="cluster_id">Cluster ID</option>
                <option value="size">Size</option>
                <option value="location">Location</option>
                <option value="timeframe">Timeframe</option>
                <option value="significance">Significance</option>
              </select>
              
              @if (analyzerResponse().length > 0) {
                <div class="bg-slate-900 p-3 rounded text-xs text-slate-300 max-h-32 overflow-y-auto">
                  {{ analyzerResponse() }}
                </div>
              }
              
              @if (analyzerResponse().length === 0 && selectedCluster()) {
                <div class="bg-slate-600 p-3 rounded text-xs text-slate-400 italic">
                  Select an analysis type above to generate insights...
                </div>
              }
              
              @if (!selectedCluster()) {
                <div class="bg-slate-600 p-3 rounded text-xs text-slate-400 italic">
                  Select a cluster first to use the analyzer.
                </div>
              }
            </div>
          </div>

          <!-- Right Graph Area -->
          <div class="bg-slate-800 relative">
            <!-- D3 Graph Container (Always Visible) -->
            <div id="graph-view" class="h-full w-full">
              <div id="graph-container" class="w-full h-full min-h-[600px]"></div>
                  
                  <!-- Graph Controls -->
                  <div class="graph-controls">
                    <div class="mb-1 font-semibold">Navigation:</div>
                    <div>• Scroll to zoom in/out</div>
                    <div>• Drag background to pan</div>
                    <div>• Drag nodes to position</div>
                    <div>• Hover nodes for details</div>
                    <div>• Click nodes to select</div>
                  </div>

                  <!-- Color Legend -->
                  <div class="graph-legend">
                    <h4 class="text-xs font-semibold text-slate-300 mb-2">Contact Risk</h4>
                    <div class="flex items-center space-x-2 text-xs">
                      <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-1"></div>
                        <span class="text-slate-400">Low</span>
                      </div>
                      <div class="w-8 h-1 bg-gradient-to-r from-green-500 via-yellow-500 to-red-500"></div>
                      <div class="flex items-center">
                        <div class="text-slate-400">High</div>
                        <div class="w-3 h-3 rounded-full bg-red-500 ml-1"></div>
                      </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Based on cluster size & overlap</div>
                  </div>

                  <!-- Selected Node Details -->
                  @if (selectedNode()) {
                    <div class="node-details">
                      <h4 class="text-sm font-semibold text-cyan-300 mb-2">Patient Details</h4>
                      <div class="text-xs text-slate-300 space-y-1">
                        <div><strong>ID:</strong> {{ selectedNode()!.id }}</div>
                        <div><strong>Infection:</strong> {{ selectedNode()!.infection }}</div>
                        <div><strong>Risk Level:</strong> <span [class]="getRiskLevelClass(selectedNode()!)">{{ getRiskLevel(selectedNode()!) }}</span></div>
                        <div><strong>Connections:</strong> {{ getNodeConnections(selectedNode()!) }} patients</div>
                      </div>
                      <button (click)="clearSelection()" class="mt-2 text-xs text-slate-400 hover:text-white transition-colors">✕ Close</button>
                    </div>
                  }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>